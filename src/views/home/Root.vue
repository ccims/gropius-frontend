<template>
    <BaseLayout
        :title-segments="titleSegments"
        :tabs="tabs"
        :right-sidebar-items="rightSidebarItems"
        :left-sidebar-items="leftSidebarItems"
    >
        <template #content>
            <router-view />
        </template>
    </BaseLayout>
</template>

<script lang="ts" setup>
import BaseLayout, { TabSegment } from "@/components/BaseLayout.vue";
import { useAppStore } from "@/store/app";
import { Events } from "@/util/eventBus";
import { eventBusKey } from "@/util/keys";
import { computed, inject } from "vue";
import { useRoute } from "vue-router";

const route = useRoute();
const eventBus = inject(eventBusKey);
const store = useAppStore();

const titleSegments = [{ name: "Gropius", path: "/" }];

const tabs = computed(() => {
    const tabs = [
        { name: "Home", path: "/" },
        { name: "Components", path: "/components" },
        { name: "Projects", path: "/projects" },
        { name: "IMSs", path: "/imss" },
        { name: "Templates", path: "/templates"}
    ];
    if (store.user?.isAdmin) {
        tabs.push({ name: "Admin", path: "/admin" });
    }
    return tabs;
});

const rightSidebarItems = computed(() => {
    if (route.name === "home" || route.name === "admin-graphiql") {
        return [];
    } else {
        const currentUser = store.user;
        let name: string;
        let eventName: keyof Events;
        let disabled: boolean;
        switch (route.name) {
            case "projects": {
                name = "project";
                eventName = "create-project";
                disabled = !(store.user?.canCreateProjects ?? false);
                break;
            }
            case "components": {
                name = "component";
                eventName = "create-component";
                disabled = !(store.user?.canCreateComponents ?? false);
                break;
            }
            case "imss": {
                name = "IMS";
                eventName = "create-ims";
                disabled = !(store.user?.canCreateIMSs ?? false);
                break;
            }
            case "templates-issue": {
                name = "issue template";
                eventName = "create-issue-template";
                disabled = !(store.user?.canCreateTemplates ?? false);
                break;
            }
            case "templates-artefact": {
                name = "artefact template";
                eventName = "create-artefact-template";
                disabled = !(store.user?.canCreateTemplates ?? false);
                break;
            }
            case "templates-component": {
                name = "component template";
                eventName = "create-component-template";
                disabled = !(store.user?.canCreateTemplates ?? false);
                break;
            }
            case "templates-interface-specification": {
                name = "interface specification template";
                eventName = "create-interface-specification-template";
                disabled = !(store.user?.canCreateTemplates ?? false);
                break;
            }
            case "templates-relation": {
                name = "relation template";
                eventName = "create-relation-template";
                disabled = !(store.user?.canCreateTemplates ?? false);
                break;
            }
            case "admin-permissions": {
                name = "permission";
                eventName = "create-permission";
                disabled = false;
                break;
            }
            case "admin-strategy-instances": {
                name = "strategy instance";
                eventName = "create-strategy-instance";
                disabled = false;
                break;
            }
            case "admin-auth-clients": {
                name = "auth client";
                eventName = "create-auth-client";
                disabled = false;
                break;
            }
            case "admin-legal-information": {
                name = "legal information";
                eventName = "create-legal-information";
                disabled = false;
                break;
            }
            default: {
                throw new Error("Unknown route");
            }
        }
        return [
            [
                {
                    icon: "mdi-plus",
                    description: `Add ${name}`,
                    color: "secondary",
                    disabled,
                    onClick: () => {
                        eventBus?.emit(eventName);
                    }
                }
            ]
        ];
    }
});

const leftSidebarItems = computed(() => {

    if (route.name?.toString().startsWith("templates")) {
        return [
        [
                {
                    icon: "$issue",
                    name: "Issue",
                    color: "secondary",
                    to: { name: "templates-issue" }
                },
                {
                    icon: "mdi-file-document",
                    name: "Artefact",
                    color: "secondary",
                    to: { name: "templates-artefact" }
                },
                {
                    icon: "$component",
                    name: "Component",
                    color: "secondary",
                    to: { name: "templates-component" }
                },
                {
                    icon: "$interface",
                    name: "Interface",
                    color: "secondary",
                    to: { name: "templates-interface-specification" }
                },
                {
                    icon: "mdi-link-variant",
                    name: "Relation",
                    color: "secondary",
                    to: { name: "templates-relation" }
                }
            ]
        ];

    }

    if (route.name?.toString().startsWith("admin")) {
        return [
            [
                {
                    icon: "mdi-shield-lock",
                    name: "Access",
                    color: "secondary",
                    to: { name: "admin-permissions" }
                },
                {
                    icon: "mdi-cogs",
                    name: "Strategies",
                    color: "secondary",
                    to: { name: "admin-strategy-instances" }
                },
                {
                    icon: "mdi-cogs",
                    name: "OAuth2",
                    color: "secondary",
                    to: { name: "admin-auth-clients" }
                },
                {
                    icon: "mdi-file-document",
                    name: "Legal",
                    color: "secondary",
                    to: { name: "admin-legal-information" }
                },
                {
                    icon: "mdi-api",
                    name: "GraphiQL",
                    color: "secondary",
                    to: { name: "admin-graphiql" }
                }
            ]
        ];
    } else {
        return [];
    }
});
</script>
